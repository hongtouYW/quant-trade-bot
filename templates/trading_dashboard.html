<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>量化交易模拟器 Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card-profit {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .card-trades {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .card-positions {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        .status-running {
            color: #28a745;
        }
        .profit-positive {
            color: #28a745;
            font-weight: bold;
        }
        .profit-negative {
            color: #dc3545;
            font-weight: bold;
        }
        .signal-buy {
            background-color: #d4edda;
            color: #155724;
        }
        .signal-sell {
            background-color: #f8d7da;
            color: #721c24;
        }
        .signal-hold {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .auto-refresh {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-light">
    <!-- 自动刷新指示器 -->
    <div class="auto-refresh">
        <span class="badge bg-success" id="refreshStatus">
            <i class="fas fa-sync-alt fa-spin"></i> 自动刷新中
        </span>
    </div>

    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center mb-0">
                    <i class="fas fa-chart-line text-primary"></i>
                    量化交易模拟器 Dashboard
                </h1>
                <p class="text-center text-muted">实时策略模拟交易系统 - 1000U本金模拟盘</p>
            </div>
        </div>

        <!-- 关键指标卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-stats">
                    <div class="card-body text-center">
                        <i class="fas fa-wallet fa-2x mb-2"></i>
                        <h5 class="card-title">账户余额</h5>
                        <h3 id="currentBalance">$0.00</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-profit">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <h5 class="card-title">总盈亏</h5>
                        <h3 id="totalPnl">+0.00%</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-trades">
                    <div class="card-body text-center">
                        <i class="fas fa-exchange-alt fa-2x mb-2"></i>
                        <h5 class="card-title">交易次数</h5>
                        <h3 id="totalTrades">0</h3>
                        <small id="winRate">胜率: 0%</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-positions">
                    <div class="card-body text-center">
                        <i class="fas fa-briefcase fa-2x mb-2"></i>
                        <h5 class="card-title">持仓数量</h5>
                        <h3 id="openPositions">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 左侧面板 -->
            <div class="col-lg-8">
                <!-- 余额变化图表 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-area"></i> 账户余额变化</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="balanceChart" height="300"></canvas>
                    </div>
                </div>

                <!-- 最近交易记录 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> 最近交易记录</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>交易对</th>
                                        <th>方向</th>
                                        <th>类型</th>
                                        <th>数量</th>
                                        <th>价格</th>
                                        <th>杠杆</th>
                                        <th>盈亏%</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="tradesTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧面板 -->
            <div class="col-lg-4">
                <!-- 当前价格 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-dollar-sign"></i> 当前价格 & 信号</h5>
                    </div>
                    <div class="card-body">
                        <div id="priceList">
                            <div class="text-center">加载中...</div>
                        </div>
                    </div>
                </div>

                <!-- 当前持仓 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-briefcase"></i> 当前持仓</h5>
                    </div>
                    <div class="card-body">
                        <div id="positionsList">
                            <div class="text-center text-muted">暂无持仓</div>
                        </div>
                    </div>
                </div>

                <!-- 策略信号 -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-brain"></i> 策略信号</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-container" style="max-height: 300px;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>交易对</th>
                                        <th>信号</th>
                                        <th>置信度</th>
                                    </tr>
                                </thead>
                                <tbody id="signalsTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let balanceChart = null;
        let refreshInterval = null;

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            initBalanceChart();
            refreshData();
            startAutoRefresh();
        });

        // 初始化余额图表
        function initBalanceChart() {
            const ctx = document.getElementById('balanceChart').getContext('2d');
            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '账户余额 (USDT)',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1,
                        fill: true
                    }, {
                        label: '总收益率 (%)',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.1,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '余额 (USDT)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '收益率 (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }

        // 开始自动刷新
        function startAutoRefresh() {
            refreshInterval = setInterval(refreshData, 10000); // 10秒刷新一次
        }

        // 停止自动刷新
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // 刷新所有数据
        function refreshData() {
            updateRefreshStatus(true);
            
            Promise.all([
                fetchAccountSummary(),
                fetchRecentTrades(),
                fetchCurrentPositions(),
                fetchStrategySignals(),
                fetchBalanceHistory(),
                fetchCurrentPrices()
            ]).then(() => {
                updateRefreshStatus(false);
            }).catch(error => {
                console.error('刷新数据失败:', error);
                updateRefreshStatus(false);
            });
        }

        // 更新刷新状态
        function updateRefreshStatus(isRefreshing) {
            const status = document.getElementById('refreshStatus');
            if (isRefreshing) {
                status.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> 刷新中...';
                status.className = 'badge bg-primary';
            } else {
                status.innerHTML = '<i class="fas fa-check"></i> 已更新';
                status.className = 'badge bg-success';
                
                // 2秒后恢复到等待状态
                setTimeout(() => {
                    status.innerHTML = '<i class="fas fa-clock"></i> 等待刷新';
                    status.className = 'badge bg-secondary';
                }, 2000);
            }
        }

        // 获取账户摘要
        async function fetchAccountSummary() {
            try {
                const response = await fetch('/api/account_summary');
                const result = await response.json();
                
                if (result.success && result.data.account) {
                    const account = result.data.account;
                    const stats = result.data.trading_stats;
                    
                    document.getElementById('currentBalance').textContent = `$${account.current_balance.toFixed(2)}`;
                    
                    const pnlElement = document.getElementById('totalPnl');
                    const pnlPercent = account.total_pnl_percent;
                    pnlElement.textContent = `${pnlPercent >= 0 ? '+' : ''}${pnlPercent.toFixed(2)}%`;
                    pnlElement.className = pnlPercent >= 0 ? 'profit-positive' : 'profit-negative';
                    
                    document.getElementById('totalTrades').textContent = stats.total_trades || 0;
                    document.getElementById('winRate').textContent = `胜率: ${(stats.win_rate || 0).toFixed(1)}%`;
                    document.getElementById('openPositions').textContent = account.open_positions || 0;
                }
            } catch (error) {
                console.error('获取账户摘要失败:', error);
            }
        }

        // 获取最近交易记录
        async function fetchRecentTrades() {
            try {
                const response = await fetch('/api/recent_trades');
                const result = await response.json();
                
                if (result.success) {
                    const tbody = document.getElementById('tradesTableBody');
                    tbody.innerHTML = '';
                    
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暂无交易记录</td></tr>';
                        return;
                    }
                    
                    result.data.forEach(trade => {
                        const row = document.createElement('tr');
                        
                        const pnlDisplay = trade.pnl_percent !== null 
                            ? `<span class="text-${trade.pnl_color}">${trade.pnl_percent >= 0 ? '+' : ''}${trade.pnl_percent.toFixed(1)}%</span>`
                            : '-';
                        
                        const statusDisplay = trade.status === 'open' 
                            ? '<span class="badge bg-primary">持仓中</span>'
                            : '<span class="badge bg-secondary">已平仓</span>';
                        
                        row.innerHTML = `
                            <td>${trade.timestamp}</td>
                            <td>${trade.symbol}</td>
                            <td>
                                <span class="badge bg-${trade.direction === 'long' ? 'success' : 'danger'}">
                                    ${trade.direction.toUpperCase()}
                                </span>
                            </td>
                            <td>${trade.type}</td>
                            <td>${trade.amount.toFixed(6)}</td>
                            <td>$${trade.price.toFixed(2)}</td>
                            <td>${trade.leverage}x</td>
                            <td>${pnlDisplay}</td>
                            <td>${statusDisplay}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('获取交易记录失败:', error);
            }
        }

        // 获取当前持仓
        async function fetchCurrentPositions() {
            try {
                const response = await fetch('/api/current_positions');
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('positionsList');
                    container.innerHTML = '';
                    
                    if (result.data.length === 0) {
                        container.innerHTML = '<div class="text-center text-muted">暂无持仓</div>';
                        return;
                    }
                    
                    result.data.forEach(position => {
                        const positionCard = document.createElement('div');
                        positionCard.className = 'card mb-2';
                        
                        const pnlColor = position.unrealized_pnl_percent >= 0 ? 'success' : 'danger';
                        const pnlIcon = position.unrealized_pnl_percent >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                        
                        positionCard.innerHTML = `
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <strong>${position.symbol}</strong>
                                    <span class="badge bg-${position.direction === 'long' ? 'success' : 'danger'}">
                                        ${position.direction.toUpperCase()} ${position.leverage}x
                                    </span>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">开仓价</small>
                                        <div>$${position.entry_price.toFixed(2)}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">当前价</small>
                                        <div>$${position.current_price.toFixed(2)}</div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="text-${pnlColor}">
                                        <i class="fas ${pnlIcon}"></i>
                                        ${position.unrealized_pnl_percent >= 0 ? '+' : ''}${position.unrealized_pnl_percent.toFixed(2)}%
                                    </span>
                                    <button class="btn btn-sm btn-outline-danger" onclick="closePosition(${position.id})">
                                        平仓
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(positionCard);
                    });
                }
            } catch (error) {
                console.error('获取持仓失败:', error);
            }
        }

        // 获取策略信号
        async function fetchStrategySignals() {
            try {
                const response = await fetch('/api/strategy_signals');
                const result = await response.json();
                
                if (result.success) {
                    const tbody = document.getElementById('signalsTableBody');
                    tbody.innerHTML = '';
                    
                    if (result.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">暂无信号</td></tr>';
                        return;
                    }
                    
                    result.data.forEach(signal => {
                        const row = document.createElement('tr');
                        
                        const signalBadge = signal.signal === 'buy' ? 'success' : 
                                          signal.signal === 'sell' ? 'danger' : 'secondary';
                        
                        row.innerHTML = `
                            <td>${signal.timestamp}</td>
                            <td>${signal.symbol}</td>
                            <td>
                                <span class="badge bg-${signalBadge}">
                                    ${signal.signal.toUpperCase()}
                                </span>
                            </td>
                            <td>${signal.confidence_percent}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('获取策略信号失败:', error);
            }
        }

        // 获取余额历史
        async function fetchBalanceHistory() {
            try {
                const response = await fetch('/api/balance_history');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const labels = result.data.map(item => item.timestamp);
                    const balances = result.data.map(item => item.balance);
                    const pnlPercents = result.data.map(item => item.total_pnl_percent || 0);
                    
                    balanceChart.data.labels = labels;
                    balanceChart.data.datasets[0].data = balances;
                    balanceChart.data.datasets[1].data = pnlPercents;
                    balanceChart.update();
                }
            } catch (error) {
                console.error('获取余额历史失败:', error);
            }
        }

        // 获取当前价格
        async function fetchCurrentPrices() {
            try {
                const response = await fetch('/api/current_prices');
                const result = await response.json();
                
                if (result.success) {
                    const container = document.getElementById('priceList');
                    container.innerHTML = '';
                    
                    const pairs = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'SOL/USDT', 'DOGE/USDT'];
                    
                    pairs.forEach(pair => {
                        if (result.data[pair]) {
                            const priceCard = document.createElement('div');
                            priceCard.className = 'card mb-2';
                            
                            const signal = result.data[`${pair}_signal`] || 'hold';
                            const confidence = result.data[`${pair}_confidence`] || 0;
                            
                            const signalColor = signal === 'buy' ? 'success' : 
                                              signal === 'sell' ? 'danger' : 'secondary';
                            
                            priceCard.innerHTML = `
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${pair}</strong>
                                            <div class="h6 mb-0">$${result.data[pair].toFixed(2)}</div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-${signalColor}">
                                                ${signal.toUpperCase()}
                                            </span>
                                            <div class="small text-muted">
                                                ${(confidence * 100).toFixed(1)}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            container.appendChild(priceCard);
                        }
                    });
                }
            } catch (error) {
                console.error('获取当前价格失败:', error);
            }
        }

        // 手动平仓
        async function closePosition(positionId) {
            try {
                const response = await fetch('/api/close_position', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        position_id: positionId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('平仓成功！');
                    refreshData(); // 刷新数据
                } else {
                    alert('平仓失败: ' + result.error);
                }
            } catch (error) {
                console.error('平仓失败:', error);
                alert('平仓失败，请稍后重试');
            }
        }

        // 页面离开前停止自动刷新
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
    </script>
</body>
</html>