<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®ç›˜æ¨¡æ‹Ÿäº¤æ˜“ç›‘æ§é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
        }

        .update-time {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .card-value.profit {
            color: #10b981;
        }

        .card-value.loss {
            color: #ef4444;
        }

        .card-subtitle {
            font-size: 12px;
            color: #999;
        }

        .section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .position-item {
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .position-symbol {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .position-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .position-type.long {
            background: #d1fae5;
            color: #065f46;
        }

        .position-type.short {
            background: #fee2e2;
            color: #991b1b;
        }

        .position-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 13px;
        }

        .position-detail {
            color: #666;
        }

        .position-detail strong {
            color: #333;
        }

        .trade-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trade-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .trade-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .trade-table tr:hover {
            background: #f9fafb;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .badge.buy {
            background: #d1fae5;
            color: #065f46;
        }

        .badge.sell {
            background: #fee2e2;
            color: #991b1b;
        }

        .profit-text {
            color: #10b981;
            font-weight: bold;
        }

        .loss-text {
            color: #ef4444;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .chart-container {
            height: 300px;
            margin-top: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .updating {
            animation: pulse 1s ease-in-out infinite;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸš€ å®ç›˜æ¨¡æ‹Ÿäº¤æ˜“ç›‘æ§é¢æ¿</h1>
            <div class="subtitle">å®æ—¶ç›‘æ§äº¤æ˜“æ•°æ® | 3å€æ æ†</div>
            <div class="update-time" id="updateTime">æ›´æ–°æ—¶é—´: --</div>
        </div>

        <!-- è´¦æˆ·ç»Ÿè®¡å¡ç‰‡ -->
        <div class="grid">
            <div class="card">
                <div class="card-title">ğŸ’° å½“å‰ä½™é¢</div>
                <div class="card-value" id="balance">$0.00</div>
                <div class="card-subtitle">å¯ç”¨èµ„é‡‘</div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“Š æ€»ç›ˆäº</div>
                <div class="card-value" id="totalPnl">$0.00</div>
                <div class="card-subtitle" id="totalReturn">æ”¶ç›Šç‡: 0.00%</div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“ˆ æ€»äº¤æ˜“</div>
                <div class="card-value" id="totalTrades">0</div>
                <div class="card-subtitle">
                    <span style="color: #10b981;" id="winningTrades">0</span> ç›ˆ | 
                    <span style="color: #ef4444;" id="losingTrades">0</span> äº
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ¯ èƒœç‡</div>
                <div class="card-value" id="winRate">0%</div>
                <div class="card-subtitle" id="totalFees">æ‰‹ç»­è´¹: $0.00</div>
            </div>
        </div>

        <!-- ä»Šæ—¥ç»Ÿè®¡ -->
        <div class="section">
            <div class="section-title">ğŸ“… ä»Šæ—¥ç»Ÿè®¡</div>
            <div class="grid">
                <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ä»Šæ—¥äº¤æ˜“</div>
                    <div style="font-size: 24px; font-weight: bold;" id="todayTrades">0 ç¬”</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ä»Šæ—¥ç›ˆäº</div>
                    <div style="font-size: 24px; font-weight: bold;" id="todayPnl">$0.00</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ä¹°å…¥/å–å‡º</div>
                    <div style="font-size: 24px; font-weight: bold;" id="todayBuySell">0 / 0</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ä»Šæ—¥æ‰‹ç»­è´¹</div>
                    <div style="font-size: 24px; font-weight: bold;" id="todayFees">$0.00</div>
                </div>
            </div>
        </div>

        <!-- å½“å‰æŒä»“ -->
        <div class="section">
            <div class="section-title">ğŸ“Š å½“å‰æŒä»“</div>
            <div id="positionsContainer">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- æœ€è¿‘äº¤æ˜“ -->
        <div class="section">
            <div class="section-title">ğŸ“‹ æœ€è¿‘äº¤æ˜“ (æœ€æ–°20ç¬”)</div>
            <div style="overflow-x: auto;">
                <table class="trade-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>äº¤æ˜“å¯¹</th>
                            <th>æ–¹å‘</th>
                            <th>ä»·æ ¼</th>
                            <th>æ•°é‡</th>
                            <th>æ æ†</th>
                            <th>ç›ˆäº</th>
                            <th>æ‰‹ç»­è´¹</th>
                            <th>åŸå› </th>
                        </tr>
                    </thead>
                    <tbody id="tradesTable">
                        <tr>
                            <td colspan="9" class="loading">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç›ˆäºå›¾è¡¨ -->
        <div class="section">
            <div class="section-title">ğŸ“ˆ æœ€è¿‘7å¤©ç›ˆäºè¶‹åŠ¿</div>
            <div class="chart-container">
                <canvas id="pnlChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let pnlChart = null;

        // æ ¼å¼åŒ–é‡‘é¢
        function formatMoney(amount) {
            return '$' + Number(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', { 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        // æ›´æ–°è´¦æˆ·ä¿¡æ¯
        async function updateAccount() {
            try {
                const response = await fetch('/api/account');
                const data = await response.json();
                
                document.getElementById('balance').textContent = formatMoney(data.balance);
                
                const pnlElement = document.getElementById('totalPnl');
                pnlElement.textContent = formatMoney(data.total_pnl);
                pnlElement.className = 'card-value ' + (data.total_pnl >= 0 ? 'profit' : 'loss');
                
                const returnPct = ((data.total_pnl / 1000) * 100).toFixed(2);
                document.getElementById('totalReturn').textContent = 'æ”¶ç›Šç‡: ' + returnPct + '%';
                
                document.getElementById('totalTrades').textContent = data.total_trades;
                document.getElementById('winningTrades').textContent = data.winning_trades;
                document.getElementById('losingTrades').textContent = data.losing_trades;
                document.getElementById('winRate').textContent = data.win_rate.toFixed(1) + '%';
                document.getElementById('totalFees').textContent = 'æ‰‹ç»­è´¹: ' + formatMoney(data.total_fees);
                
                document.getElementById('updateTime').textContent = 'æ›´æ–°æ—¶é—´: ' + formatTime(data.timestamp);
            } catch (error) {
                console.error('æ›´æ–°è´¦æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æŒä»“
        async function updatePositions() {
            try {
                const response = await fetch('/api/positions');
                const positions = await response.json();
                
                const container = document.getElementById('positionsContainer');
                
                if (positions.length === 0) {
                    container.innerHTML = '<div class="loading">æš‚æ— æŒä»“</div>';
                    return;
                }
                
                container.innerHTML = positions.map(pos => `
                    <div class="position-item">
                        <div class="position-header">
                            <div class="position-symbol">${pos.symbol}</div>
                            <div class="position-type long">ğŸ“ˆ åšå¤š ${pos.leverage}x</div>
                        </div>
                        <div class="position-details">
                            <div class="position-detail">
                                å…¥åœºä»·: <strong>${formatMoney(pos.entry_price)}</strong>
                            </div>
                            <div class="position-detail">
                                æ•°é‡: <strong>${pos.quantity.toFixed(6)}</strong>
                            </div>
                            <div class="position-detail">
                                ä¿è¯é‡‘: <strong>${formatMoney(pos.cost)}</strong>
                            </div>
                            <div class="position-detail">
                                æ­¢æŸ: <strong>${formatMoney(pos.stop_loss)}</strong>
                            </div>
                            <div class="position-detail">
                                æ­¢ç›ˆ: <strong>${formatMoney(pos.take_profit)}</strong>
                            </div>
                            <div class="position-detail">
                                æ—¶é—´: <strong>${formatTime(pos.entry_time)}</strong>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('æ›´æ–°æŒä»“å¤±è´¥:', error);
            }
        }

        // æ›´æ–°äº¤æ˜“è®°å½•
        async function updateTrades() {
            try {
                const response = await fetch('/api/trades?limit=20');
                const trades = await response.json();
                
                const tbody = document.getElementById('tradesTable');
                
                if (trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="loading">æš‚æ— äº¤æ˜“è®°å½•</td></tr>';
                    return;
                }
                
                tbody.innerHTML = trades.map(trade => {
                    const pnlClass = trade.pnl > 0 ? 'profit-text' : (trade.pnl < 0 ? 'loss-text' : '');
                    const pnlText = trade.pnl ? `${formatMoney(trade.pnl)} (${trade.pnl_pct.toFixed(2)}%)` : '-';
                    
                    return `
                        <tr>
                            <td>${formatTime(trade.timestamp)}</td>
                            <td><strong>${trade.symbol}</strong></td>
                            <td><span class="badge ${trade.side}">${trade.side === 'buy' ? 'ğŸ“ˆ ä¹°å…¥' : 'ğŸ“‰ å–å‡º'}</span></td>
                            <td>${formatMoney(trade.price)}</td>
                            <td>${trade.quantity.toFixed(6)}</td>
                            <td>${trade.leverage}x</td>
                            <td class="${pnlClass}">${pnlText}</td>
                            <td>${formatMoney(trade.fee)}</td>
                            <td>${trade.reason || '-'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('æ›´æ–°äº¤æ˜“è®°å½•å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ä»Šæ—¥ç»Ÿè®¡
        async function updateToday() {
            try {
                const response = await fetch('/api/today');
                const data = await response.json();
                
                document.getElementById('todayTrades').textContent = data.total_trades + ' ç¬”';
                
                const todayPnlElement = document.getElementById('todayPnl');
                todayPnlElement.textContent = formatMoney(data.pnl);
                todayPnlElement.className = data.pnl >= 0 ? 'profit-text' : 'loss-text';
                
                document.getElementById('todayBuySell').textContent = `${data.buy_count} / ${data.sell_count}`;
                document.getElementById('todayFees').textContent = formatMoney(data.fees);
            } catch (error) {
                console.error('æ›´æ–°ä»Šæ—¥ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æ›´æ–°å›¾è¡¨
        async function updateChart() {
            try {
                const response = await fetch('/api/daily_stats?days=7');
                const data = await response.json();
                
                const labels = data.map(d => d.date.substring(5));
                const pnlData = data.map(d => d.pnl);
                
                if (pnlChart) {
                    pnlChart.data.labels = labels;
                    pnlChart.data.datasets[0].data = pnlData;
                    pnlChart.update();
                } else {
                    const ctx = document.getElementById('pnlChart').getContext('2d');
                    pnlChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'æ¯æ—¥ç›ˆäº',
                                data: pnlData,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('æ›´æ–°å›¾è¡¨å¤±è´¥:', error);
            }
        }

        // å…¨é‡æ›´æ–°
        async function updateAll() {
            await Promise.all([
                updateAccount(),
                updatePositions(),
                updateTrades(),
                updateToday(),
                updateChart()
            ]);
        }

        // åˆå§‹åŠ è½½
        updateAll();

        // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(updateAll, 5000);
    </script>
</body>
</html>
