<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="v0.3">
    <meta name="description" content="é‡åŒ–äº¤æ˜“ç³»ç»Ÿ - æ€§èƒ½ä¼˜åŒ–ç‰ˆ">
    <title>é‡åŒ–åŠ©ç† v0.3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0f1419 0%, #1a202c 100%);
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        
        /* é¡¶éƒ¨ç»Ÿè®¡åŒº */
        .top-stats {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            color: #f1f5f9;
            font-size: 24px;
            font-weight: bold;
        }
        
        .profit { color: #10b981; }
        .loss { color: #ef4444; }
        
        /* ä¸»å®¹å™¨ */
        .main-container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            height: calc(100vh - 120px);
            gap: 1px;
        }
        
        /* å·¦ä¾§è´§å¸åˆ—è¡¨ */
        .currency-list {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            overflow-y: auto;
        }
        
        .currency-list h3 {
            color: #60a5fa;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }
        
        .currency-item {
            background: rgba(255, 255, 255, 0.05);
            margin: 8px 0;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .currency-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #60a5fa;
        }
        
        .currency-item.active {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .currency-symbol {
            font-weight: bold;
            color: #f1f5f9;
        }
        
        .currency-price {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .currency-signal {
            display: inline-block;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            font-weight: bold;
        }

        .signal-buy {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .signal-sell {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .currency-score {
            font-size: 10px;
            color: #fbbf24;
            margin-top: 2px;
        }

        .currency-reasons {
            font-size: 9px;
            color: #60a5fa;
            margin-top: 2px;
            line-height: 1.3;
        }

        /* ä¸­é—´å›¾è¡¨åŒº */
        .chart-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 20px;
        }
        
        .time-filters {
            display: flex;
            gap: 8px;
        }
        
        .time-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            color: #94a3b8;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-btn.active {
            background: #60a5fa;
            color: white;
        }
        
        .time-btn:hover {
            background: rgba(96, 165, 250, 0.3);
        }
        
        .chart-symbol {
            font-size: 24px;
            font-weight: bold;
            color: #f1f5f9;
        }
        
        .price-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .price-item {
            text-align: center;
        }
        
        .price-label {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .price-value {
            font-weight: bold;
            font-size: 14px;
        }
        
        .entry-price { color: #60a5fa; }
        .stop-loss { color: #ef4444; }
        .take-profit { color: #10b981; }
        
        .chart-wrapper {
            flex: 1;
            position: relative;
            min-height: 400px;
            height: 400px;
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            overflow: hidden;
        }
        
        #tradingChart {
            width: 100% !important;
            height: 380px !important;
            max-height: 380px;
            min-height: 380px;
            display: block !important;
        }
        
        /* å³ä¾§æŒä»“ */
        .positions-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            overflow-y: auto;
        }
        
        .panel-tabs {
            display: flex;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 4px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            background: none;
            border: none;
            color: #94a3b8;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .tab-btn.active {
            background: #60a5fa;
            color: white;
        }
        
        .trade-history {
            display: none;
        }
        
        .trade-item {
            background: rgba(255, 255, 255, 0.05);
            margin: 8px 0;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #60a5fa;
            font-size: 12px;            cursor: pointer;
            transition: all 0.2s;
        }
        
        .position-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
        }
        
        .position-item.selected {
            background: rgba(96, 165, 250, 0.2) !important;
            border-left-color: #60a5fa !important;
            box-shadow: 0 0 10px rgba(96, 165, 250, 0.3);
        }
        
        .trade-item.buy {
            border-left-color: #10b981;
        }
        
        .trade-item.sell {
            border-left-color: #ef4444;
        }
        
        .trade-symbol {
            font-weight: bold;
            color: #f1f5f9;
            margin-bottom: 4px;
        }
        
        .trade-details {
            color: #94a3b8;
            line-height: 1.3;
        }
        
        .positions-panel h3 {
            color: #60a5fa;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
        }
        
        .position-item {
            background: rgba(255, 255, 255, 0.05);
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #60a5fa;
        }
        
        .position-item.long {
            border-left-color: #10b981;
        }
        
        .position-item.short {
            border-left-color: #ef4444;
        }
        
        .position-symbol {
            font-weight: bold;
            color: #f1f5f9;
            margin-bottom: 8px;
        }
        
        .position-details {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.4;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .position-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .position-badge.long {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .position-badge.short {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .position-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .position-info .label {
            font-size: 10px;
            color: #64748b;
            margin-bottom: 2px;
        }

        .position-info .value {
            font-size: 12px;
            color: #e2e8f0;
            font-weight: 500;
        }

        .position-pnl {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
        }

        .position-pnl.profit {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .position-pnl.loss {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .position-direction {
            font-weight: bold;
        }

        .position-direction.long { color: #10b981; }
        .position-direction.short { color: #ef4444; }
        
        /* åº•éƒ¨æé†’åŒº */
        .alerts-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 100px;
            overflow-y: auto;
        }
        
        .alert-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 3px solid #fbbf24;
            font-size: 13px;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert-time {
            color: #94a3b8;
            margin-right: 10px;
        }
        
        .alert-big-money {
            border-left-color: #10b981;
        }
        
        .alert-warning {
            border-left-color: #ef4444;
        }

        /* âš¡ åŠ è½½æŒ‡ç¤ºå™¨ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(96, 165, 250, 0.2);
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: #60a5fa;
            font-size: 16px;
            font-weight: 500;
        }

        .loading-progress {
            margin-top: 10px;
            color: #94a3b8;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- âš¡ å…¨å±€åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        <div class="loading-progress" id="loadingProgress">åˆå§‹åŒ–ä¸­</div>
    </div>
    <!-- é¡¶éƒ¨ç»Ÿè®¡ -->
    <div class="top-stats">
        <!-- æœ¬é‡‘æ€»é¢ -->
        <div class="stat-card">
            <div class="stat-label">ğŸ’° æœ¬é‡‘æ€»é¢</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                <div>
                    <div style="font-size: 11px; color: #94a3b8;">åˆå§‹</div>
                    <div style="font-size: 16px; font-weight: bold; color: #60a5fa;" id="initialBalanceValue">$2000</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #94a3b8;">å¯ç”¨</div>
                    <div style="font-size: 16px; font-weight: bold; color: #10b981;" id="availableBalanceValue">$0</div>
                </div>
            </div>
            <div style="margin-top: 8px;">
                <div style="font-size: 11px; color: #94a3b8;">å ç”¨</div>
                <div style="font-size: 16px; font-weight: bold; color: #fbbf24;" id="usedBalanceValue">$0</div>
            </div>
        </div>

        <!-- æ€»ç›ˆäº -->
        <div class="stat-card">
            <div class="stat-label">ğŸ“ˆ æ€»ç›ˆäº (å·²æ‰£è´¹)</div>
            <div style="font-size: 24px; font-weight: bold; margin: 8px 0;" id="totalPnlValue">$0.00</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                <div>
                    <div style="font-size: 11px; color: #94a3b8;">äº¤æ˜“è´¹</div>
                    <div style="font-size: 14px; font-weight: bold; color: #ef4444;" id="totalFeesValue">-$0</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #94a3b8;">èµ„é‡‘è´¹</div>
                    <div style="font-size: 14px; font-weight: bold; color: #ef4444;" id="fundingFeesValue">-$0</div>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
                <div>
                    <div style="font-size: 11px; color: #94a3b8;">ç›ˆåˆ©</div>
                    <div style="font-size: 14px; font-weight: bold; color: #10b981;" id="profitValue">+$0</div>
                </div>
                <div>
                    <div style="font-size: 11px; color: #94a3b8;">äºæŸ</div>
                    <div style="font-size: 14px; font-weight: bold; color: #ef4444;" id="lossValue">-$0</div>
                </div>
            </div>
        </div>

        <!-- ç›ˆäºç™¾åˆ†æ¯” -->
        <div class="stat-card">
            <div class="stat-label">ğŸ“Š ç›ˆäºç™¾åˆ†æ¯”</div>
            <div style="font-size: 36px; font-weight: bold; margin: 12px 0;" id="pnlPercentValue">0.00%</div>
            <div style="font-size: 12px; color: #94a3b8;">
                æ€»ç›ˆäº / åˆå§‹æœ¬é‡‘ Ã— 100
            </div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 11px; color: #94a3b8;">äº¤æ˜“æ¬¡æ•°</div>
                <div style="font-size: 18px; font-weight: bold; color: #f1f5f9;" id="totalTradesValue">0</div>
            </div>
        </div>
    </div>
    
    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§è´§å¸åˆ—è¡¨ -->
        <div class="currency-list">
            <h3>ğŸ“Š ç­–ç•¥æ¨è (<span id="recommendCount">0</span>)</h3>
            <div style="font-size: 10px; color: #60a5fa; margin-bottom: 10px; text-align: center;">
                <span id="lastUpdateTime">ç­‰å¾…æ›´æ–°...</span> | â° 10åˆ†é’Ÿåˆ·æ–°
            </div>
            <div id="currencyListContainer">
                <div style="text-align: center; color: #94a3b8; padding: 20px; font-size: 12px;">
                    ğŸ” æ­£åœ¨æ‰«æå¸‚åœºæœºä¼š...
                </div>
            </div>
        </div>
        
        <!-- ä¸­é—´å›¾è¡¨åŒº -->
        <div class="chart-container">
            <div class="chart-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div class="chart-symbol" id="currentSymbol">BTC/USDT</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="cacheStatus" style="font-size: 11px; color: #60a5fa;">ğŸ”µ ç¼“å­˜å°±ç»ª</span>
                        <button onclick="refreshCache()" title="åˆ·æ–°ç¼“å­˜æ•°æ®" style="background: rgba(96, 165, 250, 0.2); border: 1px solid #60a5fa; color: #60a5fa; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">ğŸ”„</button>
                    </div>
                </div>
                <div class="time-filters">
                    <button class="time-btn active" onclick="changeTimeframe('5m', event)">5åˆ†é’Ÿ</button>
                    <button class="time-btn" onclick="changeTimeframe('10m', event)">10åˆ†é’Ÿ</button>
                    <button class="time-btn" onclick="changeTimeframe('15m', event)">15åˆ†é’Ÿ</button>
                    <button class="time-btn" onclick="changeTimeframe('1h', event)">1å°æ—¶</button>
                    <button class="time-btn" onclick="changeTimeframe('4h', event)">4å°æ—¶</button>
                    <button class="time-btn" onclick="changeTimeframe('8h', event)">8å°æ—¶</button>
                    <button class="time-btn" onclick="changeTimeframe('1d', event)">1å¤©</button>
                </div>
                <div class="price-info">
                    <div class="price-item">
                        <div class="price-label">ä¹°å…¥ä»·</div>
                        <div class="price-value entry-price" id="entryPrice">$87,738.01</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">æ­¢æŸä»·</div>
                        <div class="price-value stop-loss" id="stopLoss">$85,000.00</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">æ­¢ç›ˆä»·</div>
                        <div class="price-value take-profit" id="takeProfit">$95,000.00</div>
                    </div>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="tradingChart"></canvas>
                <div id="chartStatus" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px; font-size: 12px; color: #60a5fa;">
                    ğŸ“Š å›¾è¡¨åŠ è½½ä¸­...
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§æŒä»“ -->
        <div class="positions-panel">
            <div class="panel-tabs">
                <button class="tab-btn active" onclick="showTab('positions')">ğŸ“¼ æŒä»“(<span id="positionCount">0</span>)</button>
                <button class="tab-btn" onclick="showTab('history')">ğŸ“Š å†å²</button>
            </div>
            
            <div id="positions-tab">
                <div style="text-align: center; color: #94a3b8; padding: 20px;">æ­£åœ¨åŠ è½½æŒä»“æ•°æ®...</div>
            </div>

            <div id="history-tab" class="trade-history">
                <div id="trade-history-content">
                    <div style="text-align: center; color: #94a3b8; padding: 20px;">
                        ğŸ“Š æ­£åœ¨åŠ è½½äº¤æ˜“å†å²...
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <!-- åº•éƒ¨æé†’ -->
    <div class="alerts-panel" id="alertsPanel">
        <div class="alert-item">
            <span class="alert-time">02:30:15</span>
            ğŸ“Š é‡åŒ–åŠ©ç†æé†’: ç›‘æ§13ä¸ªè´§å¸å¯¹ï¼Œ5ä¸ªå¤šå¤´ï¼Œ8ä¸ªç©ºå¤´ä»“ä½
        </div>
        <div class="alert-item alert-big-money">
            <span class="alert-time">02:29:43</span>
            ğŸ’° å¤§èµ„é‡‘æµå…¥: BTC/USDT æ£€æµ‹åˆ°3.2M USDTä¹°ç›˜æ”¯æ’‘
        </div>
        <div class="alert-item alert-warning">
            <span class="alert-time">02:28:21</span>
            âš ï¸ é£é™©æé†’: SOL/USDT ç©ºå¤´ä»“ä½ä»·æ ¼æ¥è¿‘æ­¢æŸçº¿
        </div>
    </div>
    
    <!-- Chart.js åº“ - ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ -->
    <script src="chart.min.js"></script>
    <!-- Chart.js Annotation æ’ä»¶ - ç”¨äºåœ¨å›¾è¡¨ä¸Šæ·»åŠ æ ‡æ³¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <script>
        // å›¾è¡¨åˆå§‹åŒ–
        let chart;
        let currentTimeframe = '5m';
        let currentPosition = null;
        let chartRetryCount = 0;
        const MAX_CHART_RETRY = 10; // æœ€å¤šé‡è¯•10æ¬¡
        
        // ç¼“å­˜ç³»ç»Ÿ
        let chartCache = {};
        let tradeHistoryCache = null;
        let positionsCache = null;
        let lastCacheUpdate = 0;
        const CACHE_DURATION = 30000; // 30ç§’ç¼“å­˜æ—¶é—´
        
        // ç¼“å­˜è¾…åŠ©å‡½æ•°
        function isCacheValid() {
            return (Date.now() - lastCacheUpdate) < CACHE_DURATION;
        }
        
        function updateCacheTime() {
            lastCacheUpdate = Date.now();
            updateCacheStatus();
        }
        
        // æ›´æ–°ç¼“å­˜çŠ¶æ€æ˜¾ç¤º
        function updateCacheStatus() {
            const statusElement = document.getElementById('cacheStatus');
            if (statusElement) {
                if (lastCacheUpdate === 0) {
                    statusElement.innerHTML = 'ğŸ”µ ç¼“å­˜å°±ç»ª';
                    statusElement.style.color = '#60a5fa';
                } else if (isCacheValid()) {
                    statusElement.innerHTML = 'ğŸŸ¢ ç¼“å­˜æ´»è·ƒ';
                    statusElement.style.color = '#10b981';
                } else {
                    statusElement.innerHTML = 'ğŸŸ¡ ç¼“å­˜è¿‡æœŸ';
                    statusElement.style.color = '#f59e0b';
                }
            }
        }
        
        // ç”Ÿæˆç¤ºä¾‹æ•°æ®å‡½æ•°
        function generateSampleData(symbol, basePrice) {
            if (!priceData[symbol]) {
                priceData[symbol] = { labels: [], data: [] };
            }
            
            // æ¸…ç©ºç°æœ‰æ•°æ®
            priceData[symbol].labels = [];
            priceData[symbol].data = [];
            
            const dataPoints = 50; // ç”Ÿæˆ50ä¸ªæ•°æ®ç‚¹
            const now = new Date();
            
            let currentPrice = basePrice;
            
            for (let i = dataPoints; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 15 * 60000); // 15åˆ†é’Ÿé—´éš”
                const timeStr = time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                
                // æ¨¡æ‹Ÿä»·æ ¼æ³¢åŠ¨
                const volatility = basePrice * 0.02; // 2% æ³¢åŠ¨
                const change = (Math.random() - 0.5) * 2 * volatility;
                currentPrice = Math.max(0.001, currentPrice + change);
                
                priceData[symbol].labels.push(timeStr);
                priceData[symbol].data.push({
                    x: timeStr,
                    o: currentPrice,
                    h: currentPrice * (1 + Math.random() * 0.005),
                    l: currentPrice * (1 - Math.random() * 0.005),
                    c: currentPrice
                });
            }
            
            console.log(`ä¸º ${symbol} ç”Ÿæˆäº† ${priceData[symbol].data.length} ä¸ªæ•°æ®ç‚¹`);
        }
        
        // æ¨¡æ‹Ÿä»·æ ¼æ•°æ®
        const priceData = {
            'BTC/USDT': {
                labels: [],
                data: [],
                entryPrice: 87738.01,
                stopLoss: 85000.00,
                takeProfit: 95000.00
            },
            'SOL/USDT': {
                labels: [],
                data: [],
                entryPrice: 124.58,
                stopLoss: 115.00,
                takeProfit: 140.00
            },
            'XRP/USDT': {
                labels: [],
                data: [],
                entryPrice: 1.9209,
                stopLoss: 1.75,
                takeProfit: 2.20
            },
            'AVAX/USDT': {
                labels: [],
                data: [],
                entryPrice: 11.77,
                stopLoss: 10.50,
                takeProfit: 13.50
            },
            'DOT/USDT': {
                labels: [],
                data: [],
                entryPrice: 1.878,
                stopLoss: 1.65,
                takeProfit: 2.15
            },
            'ETH/USDT': {
                labels: [],
                data: [],
                entryPrice: 3245.67,
                stopLoss: 3000.00,
                takeProfit: 3500.00
            }
        };
        
        // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼ˆæ ¹æ®æ—¶é—´æ¡†æ¶ï¼‰
        function generateMockData(symbol, timeframe = '15m') {
            const basePrice = priceData[symbol].entryPrice;
            const labels = [];
            const data = [];
            const now = new Date();
            
            // æ ¹æ®æ—¶é—´æ¡†æ¶è®¾ç½®æ•°æ®ç‚¹æ•°é‡å’Œæ—¶é—´é—´éš”
            let pointCount, interval, timeFormat;
            switch(timeframe) {
                case '15m':
                    pointCount = 30;
                    interval = 15 * 60 * 1000; // 15åˆ†é’Ÿ
                    timeFormat = (time) => time.toLocaleTimeString().slice(0, -3);
                    break;
                case '1h':
                    pointCount = 24;
                    interval = 60 * 60 * 1000; // 1å°æ—¶
                    timeFormat = (time) => `${time.getMonth()+1}/${time.getDate()} ${time.getHours()}:00`;
                    break;
                case '1d':
                    pointCount = 30;
                    interval = 24 * 60 * 60 * 1000; // 1å¤©
                    timeFormat = (time) => `${time.getMonth()+1}/${time.getDate()}`;
                    break;
                default:
                    pointCount = 30;
                    interval = 15 * 60 * 1000;
                    timeFormat = (time) => time.toLocaleTimeString().slice(0, -3);
            }
            
            for (let i = pointCount - 1; i >= 0; i--) {
                const time = new Date(now.getTime() - i * interval);
                labels.push(timeFormat(time));
                
                // ç”Ÿæˆéšæœºä»·æ ¼å˜åŠ¨
                const variation = (Math.random() - 0.5) * basePrice * 0.02;
                const price = basePrice + variation;
                data.push(price);
            }
            
            priceData[symbol].labels = labels;
            priceData[symbol].data = data;
        }
        
        // åˆ‡æ¢æ—¶é—´æ¡†æ¶
        function changeTimeframe(timeframe, evt) {
            currentTimeframe = timeframe;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            if (evt && evt.target) {
                evt.target.classList.add('active');
            }

            // é‡æ–°ç”Ÿæˆå½“å‰è´§å¸çš„æ•°æ®
            const currentSymbol = document.getElementById('currentSymbol').textContent;
            createChart(currentSymbol);

            addAlert(`ğŸ•’ å·²åˆ‡æ¢åˆ°${timeframe}æ—¶é—´æ¡†æ¶`, '');
        }
        
        // åŠ è½½æŒä»“å›¾è¡¨åˆ†æ
        function loadPositionChart(symbol, entryPrice, stopPrice, targetPrice, direction, clickedElement = null, openTime = null, closeTime = null, closePrice = null) {
            console.log(`ğŸ¯ åŠ è½½æŒä»“å›¾è¡¨: ${symbol}, æ–¹å‘: ${direction}, å…¥åœºä»·: ${entryPrice}`);

            // æ›´æ–°å½“å‰æŒä»“ä¿¡æ¯
            currentPosition = {
                symbol: symbol,
                entryPrice: entryPrice,
                stopPrice: stopPrice,
                targetPrice: targetPrice,
                direction: direction,
                openTime: openTime,
                closeTime: closeTime,
                closePrice: closePrice
            };
            
            // ç¡®ä¿æ•°æ®å­˜åœ¨ï¼Œä¼˜å…ˆä½¿ç”¨ç¼“å­˜
            if (!priceData[symbol] || !chartCache[symbol]) {
                console.log(`ä¸º ${symbol} ç”Ÿæˆæ–°æ•°æ®`);
                priceData[symbol] = {
                    labels: [],
                    data: [],
                    entryPrice: entryPrice,
                    stopLoss: stopPrice,
                    takeProfit: targetPrice
                };
                generateSampleData(symbol, entryPrice);
                chartCache[symbol] = true; // æ ‡è®°å·²ç¼“å­˜
            } else {
                console.log(`ä½¿ç”¨ ${symbol} çš„ç¼“å­˜æ•°æ®`);
                // æ›´æ–°ä»·æ ¼ä¿¡æ¯ä½†ä¿ç•™æ•°æ®
                priceData[symbol].entryPrice = entryPrice;
                priceData[symbol].stopLoss = stopPrice;
                priceData[symbol].takeProfit = targetPrice;
            }
            
            // å¼ºåˆ¶æ›´æ–°UI
            updateChartUI(symbol, entryPrice, stopPrice, targetPrice);
            
            // é«˜äº®é€‰ä¸­é¡¹
            highlightSelection(symbol, clickedElement);
            
            // å¼ºåˆ¶é‡æ–°åˆ›å»ºå›¾è¡¨
            console.log(`ğŸ”„ å¼ºåˆ¶é‡æ–°åˆ›å»ºå›¾è¡¨: ${symbol}`);
            if (chart) {
                chart.destroy();
                chart = null;
            }
            
            setTimeout(() => {
                createChart(symbol);
                addAlert(`ğŸ¯ å·²åˆ‡æ¢åˆ° ${symbol} ${direction === 'long' || direction === 'buy' ? 'å¤šå¤´' : 'ç©ºå¤´'}æŒä»“åˆ†æ`, '');
            }, 100); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿DOMæ›´æ–°
        }
        
        // æ›´æ–°å›¾è¡¨UIä¿¡æ¯
        function updateChartUI(symbol, entryPrice, stopPrice, targetPrice) {
            // æ›´æ–°å½“å‰è´§å¸æ˜¾ç¤º
            document.getElementById('currentSymbol').textContent = symbol;
            
            // æ›´æ–°ä»·æ ¼ä¿¡æ¯æ˜¾ç¤º
            document.getElementById('entryPrice').textContent = `$${parseFloat(entryPrice).toLocaleString()}`;
            document.getElementById('stopLoss').textContent = `$${parseFloat(stopPrice).toLocaleString()}`;
            document.getElementById('takeProfit').textContent = `$${parseFloat(targetPrice).toLocaleString()}`;
            
            console.log(`âœ… å·²æ›´æ–°UI: ${symbol} å…¥åœº:${entryPrice} æ­¢æŸ:${stopPrice} æ­¢ç›ˆ:${targetPrice}`);
        }
        
        // é«˜äº®é€‰ä¸­é¡¹
        function highlightSelection(symbol, clickedElement) {
            // æ›´æ–°å·¦ä¾§è´§å¸åˆ—è¡¨çŠ¶æ€
            document.querySelectorAll('.currency-item').forEach(i => i.classList.remove('active'));
            const currencyItem = document.querySelector(`[data-symbol="${symbol}"]`);
            if (currencyItem) {
                currencyItem.classList.add('active');
            }
            
            // é«˜äº®é€‰ä¸­çš„æŒä»“æˆ–äº¤æ˜“è®°å½•
            document.querySelectorAll('.position-item, .trade-item').forEach(item => item.classList.remove('selected'));
            if (clickedElement) {
                const parentItem = clickedElement.closest('.position-item, .trade-item');
                if (parentItem) {
                    parentItem.classList.add('selected');
                }
            }
        }
        
        // åˆ›å»ºå›¾è¡¨
        async function createChart(symbol) {
            console.log(`ğŸ¨ å¼€å§‹åˆ›å»ºå›¾è¡¨: ${symbol}`);

            // æ£€æŸ¥ Chart.js æ˜¯å¦å·²åŠ è½½
            if (typeof Chart === 'undefined') {
                chartRetryCount++;
                if (chartRetryCount > MAX_CHART_RETRY) {
                    console.error('âŒ Chart.js åŠ è½½å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
                    addAlert('âŒ å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'alert-warning');
                    chartRetryCount = 0; // é‡ç½®è®¡æ•°å™¨
                    return;
                }
                console.warn(`â³ Chart.js è¿˜æœªåŠ è½½ï¼Œç­‰å¾…ä¸­... (${chartRetryCount}/${MAX_CHART_RETRY})`);
                // ç­‰å¾…500msåé‡è¯•
                setTimeout(() => createChart(symbol), 500);
                return;
            }

            // Chart.js å·²åŠ è½½ï¼Œé‡ç½®è®¡æ•°å™¨
            chartRetryCount = 0;

            try {
                // æ¸…ç†æ—§å›¾è¡¨
                if (chart) {
                    console.log('ğŸ—‘ï¸ é”€æ¯æ—§å›¾è¡¨');
                    chart.destroy();
                    chart = null;
                }

                const canvas = document.getElementById('tradingChart');
                if (!canvas) {
                    console.error('âŒ æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨');
                    addAlert('âš ï¸ å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°', 'alert-warning');
                    return;
                }

                console.log('âœ… æ‰¾åˆ°å›¾è¡¨å®¹å™¨');
                const ctx = canvas.getContext('2d');

                // âš¡ ä¼˜åŒ–ï¼šå‡å°‘Kçº¿æ•°é‡ï¼ˆ50 â†’ 30ï¼‰ï¼ŒåŠ å¿«æ¸²æŸ“
                console.log(`ğŸ“¡ ä»APIè·å– ${symbol} çš„Kçº¿æ•°æ®ï¼Œæ—¶é—´å‘¨æœŸ: ${currentTimeframe}`);
                const apiUrl = `/api/kline/${symbol}?timeframe=${currentTimeframe}&limit=30`;
                console.log(`ğŸ”— API URL: ${apiUrl}`);

                const response = await fetch(apiUrl);
                console.log(`ğŸ“¥ API å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }

                const klines = await response.json();
                console.log(`âœ… è·å–åˆ° ${klines.length} ä¸ªKçº¿æ•°æ®ç‚¹`);
                console.log('ğŸ“Š æ•°æ®ç¤ºä¾‹:', klines[0]);

                if (!klines || klines.length === 0) {
                    console.warn('âš ï¸ æ²¡æœ‰è·å–åˆ°Kçº¿æ•°æ®');
                    addAlert('âš ï¸ æš‚æ— æ•°æ®', 'alert-warning');
                    return;
                }

                // æ£€æŸ¥æ•°æ®æ ¼å¼
                if (!klines[0].close || !klines[0].timestamp) {
                    console.error('âŒ æ•°æ®æ ¼å¼é”™è¯¯:', klines[0]);
                    addAlert('âŒ æ•°æ®æ ¼å¼é”™è¯¯', 'alert-warning');
                    return;
                }

                // æ ¼å¼åŒ–æ•°æ®
                const labels = klines.map(k => {
                    const date = new Date(k.timestamp);
                    if (currentTimeframe === '1d') {
                        return date.toLocaleDateString();
                    } else {
                        return date.toLocaleTimeString().slice(0, -3);
                    }
                });
                const closeData = klines.map(k => k.close);

                console.log(`ğŸ“Š åˆ›å»ºå›¾è¡¨ï¼Œæ•°æ®ç‚¹æ•°: ${closeData.length}`);

                // æ„å»ºannotationé…ç½®
                const annotations = {};

                // æ·»åŠ æŒä»“ä»·ä½æ³¨é‡Š
                try {
                    const positionsRes = await fetch('/api/positions');
                    const allPositions = await positionsRes.json();
                    const symbolPositions = allPositions.filter(p => p.symbol === symbol);

                    const tradesRes = await fetch('/api/trades?limit=50');
                    const allTrades = await tradesRes.json();
                    const symbolTrades = allTrades.filter(t => t.symbol === symbol);

                    symbolPositions.forEach((pos, idx) => {
                        const suffix = symbolPositions.length > 1 ? `_${idx}` : '';

                        // å…¥åœºä»·çº¿
                        annotations[`entry${suffix}`] = {
                            type: 'line',
                            yMin: pos.entry_price,
                            yMax: pos.entry_price,
                            borderColor: '#fbbf24',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            label: {
                                display: true,
                                content: `å…¥åœº $${pos.entry_price.toFixed(4)}`,
                                position: 'end',
                                backgroundColor: 'rgba(251, 191, 36, 0.8)',
                                color: '#000',
                                font: { size: 11, weight: 'bold' }
                            }
                        };

                        // æ­¢æŸçº¿
                        if (pos.stop_loss) {
                            annotations[`stop${suffix}`] = {
                                type: 'line',
                                yMin: pos.stop_loss,
                                yMax: pos.stop_loss,
                                borderColor: '#ef4444',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    display: true,
                                    content: `æ­¢æŸ $${pos.stop_loss.toFixed(4)}`,
                                    position: 'end',
                                    backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                    color: '#fff',
                                    font: { size: 11, weight: 'bold' }
                                }
                            };
                        }

                        // æ­¢ç›ˆçº¿
                        if (pos.take_profit) {
                            annotations[`target${suffix}`] = {
                                type: 'line',
                                yMin: pos.take_profit,
                                yMax: pos.take_profit,
                                borderColor: '#10b981',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    display: true,
                                    content: `æ­¢ç›ˆ $${pos.take_profit.toFixed(4)}`,
                                    position: 'end',
                                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                    color: '#fff',
                                    font: { size: 11, weight: 'bold' }
                                }
                            };
                        }
                    });

                    // âš¡ å†å²äº¤æ˜“æ ‡è®°ï¼ˆä»…åœ¨éå¤ç›˜æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
                    if (!currentPosition.openTime) {
                        symbolTrades.slice(0, 5).forEach((trade, idx) => {
                            const isBuy = trade.side === 'buy';
                            const color = isBuy ? '#10b981' : '#ef4444';
                            const label = isBuy ? 'ä¹°' : 'å–';
                            const tradeTime = new Date(trade.timestamp);
                            const tradePrice = parseFloat(trade.price);

                            // æŸ¥æ‰¾äº¤æ˜“æ—¶é—´åœ¨Kçº¿æ•°æ®ä¸­çš„ä½ç½®
                            const tradeTimestamp = tradeTime.getTime();
                            const klineTimestamps = klines.map(k => new Date(k.timestamp).getTime());

                            // æ‰¾åˆ°æœ€æ¥è¿‘çš„Kçº¿ç´¢å¼•
                            let closestIndex = -1;
                            let minDiff = Infinity;

                            klineTimestamps.forEach((ts, i) => {
                                const diff = Math.abs(ts - tradeTimestamp);
                                if (diff < minDiff) {
                                    minDiff = diff;
                                    closestIndex = i;
                                }
                            });

                            // å¦‚æœæ‰¾åˆ°äº†å¯¹åº”çš„æ—¶é—´ç‚¹ï¼Œæ·»åŠ ç‚¹æ ‡è®°
                            if (closestIndex >= 0 && minDiff < 24 * 60 * 60 * 1000) { // 24å°æ—¶å†…
                                const timeLabel = labels[closestIndex];

                                annotations[`trade_point_${idx}`] = {
                                    type: 'point',
                                    xValue: timeLabel,
                                    yValue: tradePrice,
                                    backgroundColor: color,
                                    borderColor: '#fff',
                                    borderWidth: 1,
                                    radius: 4,
                                    label: {
                                        display: true,
                                        content: `${label} $${tradePrice.toFixed(4)}`,
                                        position: 'top',
                                        backgroundColor: isBuy ? 'rgba(16, 185, 129, 0.95)' : 'rgba(239, 68, 68, 0.95)',
                                        color: '#fff',
                                        font: { size: 9, weight: 'bold' },
                                        padding: 3,
                                        yAdjust: -10
                                    }
                                };
                            }
                        });
                    }

                    // æ·»åŠ æŒä»“å¼€ä»“ç‚¹æ ‡è®°
                    symbolPositions.forEach((pos, idx) => {
                        const suffix = symbolPositions.length > 1 ? `_${idx}` : '';
                        if (pos.entry_time) {
                            const entryTime = new Date(pos.entry_time);
                            const entryTimestamp = entryTime.getTime();
                            const klineTimestamps = klines.map(k => new Date(k.timestamp).getTime());

                            let closestIndex = -1;
                            let minDiff = Infinity;

                            klineTimestamps.forEach((ts, i) => {
                                const diff = Math.abs(ts - entryTimestamp);
                                if (diff < minDiff) {
                                    minDiff = diff;
                                    closestIndex = i;
                                }
                            });

                            if (closestIndex >= 0 && minDiff < 24 * 60 * 60 * 1000) {
                                const timeLabel = labels[closestIndex];
                                const timeStr = `${entryTime.getMonth()+1}/${entryTime.getDate()} ${entryTime.getHours()}:${String(entryTime.getMinutes()).padStart(2,'0')}`;

                                annotations[`position_point${suffix}`] = {
                                    type: 'point',
                                    xValue: timeLabel,
                                    yValue: pos.entry_price,
                                    backgroundColor: '#fbbf24',
                                    borderColor: '#fff',
                                    borderWidth: 1,
                                    radius: 5,
                                    label: {
                                        display: true,
                                        content: `å¼€ä»“ $${pos.entry_price.toFixed(4)}`,
                                        position: 'top',
                                        backgroundColor: 'rgba(251, 191, 36, 0.95)',
                                        color: '#000',
                                        font: { size: 9, weight: 'bold' },
                                        padding: 3,
                                        yAdjust: -10
                                    }
                                };
                            }
                        }
                    });

                    // æ·»åŠ å¤ç›˜æ ‡è®°ï¼šæ˜¾ç¤ºå½“æ—¶çš„å¼€ä»“ã€å¹³ä»“ã€æ­¢æŸã€æ­¢ç›ˆä½ç½®
                    if (currentPosition.openTime) {
                        const openTime = new Date(currentPosition.openTime);
                        const openTimestamp = openTime.getTime();
                        const klineTimestamps = klines.map(k => new Date(k.timestamp).getTime());

                        // æ‰¾åˆ°å¼€ä»“æ—¶é—´æœ€æ¥è¿‘çš„Kçº¿ç´¢å¼•
                        let openIndex = -1;
                        let minDiff = Infinity;
                        klineTimestamps.forEach((ts, i) => {
                            const diff = Math.abs(ts - openTimestamp);
                            if (diff < minDiff) {
                                minDiff = diff;
                                openIndex = i;
                            }
                        });

                        if (openIndex >= 0 && minDiff < 24 * 60 * 60 * 1000) {
                            const openLabel = labels[openIndex];

                            // âš¡ å…¥åœºç‚¹æ ‡è®°ï¼ˆåªæ˜¾ç¤ºç‚¹ï¼Œä¸æ˜¾ç¤ºçº¿ï¼‰
                            annotations['review_entry'] = {
                                type: 'point',
                                xValue: openLabel,
                                yValue: currentPosition.entryPrice,
                                backgroundColor: '#fbbf24',
                                borderColor: '#fff',
                                borderWidth: 2,
                                radius: 8,
                                label: {
                                    display: true,
                                    content: `ğŸ“ å…¥åœº $${currentPosition.entryPrice.toFixed(4)}`,
                                    position: 'top',
                                    backgroundColor: 'rgba(251, 191, 36, 0.95)',
                                    color: '#000',
                                    font: { size: 11, weight: 'bold' },
                                    padding: 5,
                                    yAdjust: -15
                                }
                            };

                            // âš¡ æ­¢æŸä½æ°´å¹³çº¿ï¼ˆåªæ˜¾ç¤ºçº¿ï¼Œä¸æ˜¾ç¤ºç‚¹ï¼Œé¿å…æ··æ·†ï¼‰
                            if (currentPosition.stopPrice) {
                                annotations['review_stop_line'] = {
                                    type: 'line',
                                    yMin: currentPosition.stopPrice,
                                    yMax: currentPosition.stopPrice,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: `ğŸ›‘ æ­¢æŸ $${currentPosition.stopPrice.toFixed(4)}`,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.9)',
                                        color: '#fff',
                                        font: { size: 11, weight: 'bold' },
                                        padding: 4
                                    }
                                };
                            }

                            // âš¡ æ­¢ç›ˆä½æ°´å¹³çº¿ï¼ˆåªæ˜¾ç¤ºçº¿ï¼Œä¸æ˜¾ç¤ºç‚¹ï¼Œé¿å…æ··æ·†ï¼‰
                            if (currentPosition.targetPrice) {
                                annotations['review_target_line'] = {
                                    type: 'line',
                                    yMin: currentPosition.targetPrice,
                                    yMax: currentPosition.targetPrice,
                                    borderColor: '#10b981',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: `ğŸ¯ æ­¢ç›ˆ $${currentPosition.targetPrice.toFixed(4)}`,
                                        position: 'end',
                                        backgroundColor: 'rgba(16, 185, 129, 0.9)',
                                        color: '#fff',
                                        font: { size: 11, weight: 'bold' },
                                        padding: 4
                                    }
                                };
                            }
                        }

                        // å¦‚æœæœ‰å¹³ä»“æ—¶é—´å’Œä»·æ ¼ï¼Œæ·»åŠ å¹³ä»“ç‚¹æ ‡è®°
                        if (currentPosition.closeTime && currentPosition.closePrice) {
                            const closeTime = new Date(currentPosition.closeTime);
                            const closeTimestamp = closeTime.getTime();

                            // æ‰¾åˆ°å¹³ä»“æ—¶é—´æœ€æ¥è¿‘çš„Kçº¿ç´¢å¼•
                            let closeIndex = -1;
                            minDiff = Infinity;
                            klineTimestamps.forEach((ts, i) => {
                                const diff = Math.abs(ts - closeTimestamp);
                                if (diff < minDiff) {
                                    minDiff = diff;
                                    closeIndex = i;
                                }
                            });

                            if (closeIndex >= 0 && minDiff < 24 * 60 * 60 * 1000) {
                                const closeLabel = labels[closeIndex];
                                const isProfitable = currentPosition.direction === 'long'
                                    ? currentPosition.closePrice > currentPosition.entryPrice
                                    : currentPosition.closePrice < currentPosition.entryPrice;

                                const pnlText = isProfitable ? 'âœ… ç›ˆåˆ©' : 'âŒ äºæŸ';

                                // âš¡ å¹³ä»“ä»·æ°´å¹³çº¿ï¼ˆåªæ˜¾ç¤ºçº¿ï¼Œä¸æ˜¾ç¤ºç‚¹ï¼‰
                                annotations['review_exit_line'] = {
                                    type: 'line',
                                    yMin: currentPosition.closePrice,
                                    yMax: currentPosition.closePrice,
                                    borderColor: isProfitable ? '#10b981' : '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [8, 4],
                                    label: {
                                        display: true,
                                        content: `${pnlText} å¹³ä»“ $${currentPosition.closePrice.toFixed(4)}`,
                                        position: 'start',
                                        backgroundColor: isProfitable ? 'rgba(16, 185, 129, 0.9)' : 'rgba(239, 68, 68, 0.9)',
                                        color: '#fff',
                                        font: { size: 11, weight: 'bold' },
                                        padding: 4
                                    }
                                };
                            }
                        }
                    }

                } catch (error) {
                    console.error('âŒ è·å–ä»·ä½æ•°æ®å¤±è´¥:', error);
                }

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: symbol + ' ä»·æ ¼',
                            data: closeData,
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: symbol + ' ä»·æ ¼èµ°åŠ¿ (' + currentTimeframe + ')',
                                color: '#e2e8f0'
                            },
                            legend: {
                                labels: {
                                    color: '#e2e8f0'
                                }
                            },
                            annotation: {
                                annotations: annotations
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#e2e8f0'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#e2e8f0'
                                }
                            }
                        }
                    }
                });

                console.log('âœ… å›¾è¡¨åˆ›å»ºæˆåŠŸ');
                addAlert(`ğŸ“Š ${symbol} å›¾è¡¨å·²åŠ è½½`, 'alert-success');

            } catch (error) {
                console.error('âŒ å›¾è¡¨åˆ›å»ºå¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                addAlert('âš ï¸ å›¾è¡¨åˆ›å»ºå¤±è´¥: ' + error.message, 'alert-warning');
            }
        }

        // è´§å¸åˆ—è¡¨ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.currency-item').forEach(item => {
            item.addEventListener('click', function() {
                // ç§»é™¤å…¶ä»–activeçŠ¶æ€
                document.querySelectorAll('.currency-item').forEach(i => i.classList.remove('active'));
                // æ·»åŠ activeçŠ¶æ€
                this.classList.add('active');
                
                const symbol = this.getAttribute('data-symbol');
                
                // æ›´æ–°å›¾è¡¨å¤´éƒ¨ä¿¡æ¯
                document.getElementById('currentSymbol').textContent = symbol;
                
                if (priceData[symbol]) {
                    document.getElementById('entryPrice').textContent = '$' + priceData[symbol].entryPrice.toFixed(2);
                    document.getElementById('stopLoss').textContent = '$' + priceData[symbol].stopLoss.toFixed(2);
                    document.getElementById('takeProfit').textContent = '$' + priceData[symbol].takeProfit.toFixed(2);
                    
                    // é‡æ–°åˆ›å»ºå›¾è¡¨
                    createChart(symbol);
                }
            });
        });
        
        // æ·»åŠ å®æ—¶æé†’
        function addAlert(message, type = '') {
            const alertsPanel = document.getElementById('alertsPanel');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert-item ' + type;
            
            const now = new Date();
            const timeStr = now.toTimeString().slice(0, 8);
            
            alertDiv.innerHTML = `
                <span class="alert-time">${timeStr}</span>
                ${message}
            `;
            
            alertsPanel.insertBefore(alertDiv, alertsPanel.firstChild);
            
            // é™åˆ¶æé†’æ•°é‡
            const alerts = alertsPanel.querySelectorAll('.alert-item');
            if (alerts.length > 5) {
                alertsPanel.removeChild(alerts[alerts.length - 1]);
            }
        }
        
        // åˆ‡æ¢è´§å¸å¯¹å‡½æ•°
        function switchCurrency(symbol) {
            // ç§»é™¤å…¶ä»–activeçŠ¶æ€
            document.querySelectorAll('.currency-item').forEach(i => i.classList.remove('active'));
            // æ·»åŠ å½“å‰activeçŠ¶æ€
            const currencyItem = document.querySelector(`[data-symbol="${symbol}"]`);
            if (currencyItem) {
                currencyItem.classList.add('active');
            }

            // æ›´æ–°å›¾è¡¨å¤´éƒ¨ä¿¡æ¯
            document.getElementById('currentSymbol').textContent = symbol;

            // åˆ›å»ºå›¾è¡¨ï¼ˆä»APIåŠ è½½çœŸå®æ•°æ®ï¼‰
            createChart(symbol);

            addAlert(`ğŸ“Š å·²åˆ‡æ¢åˆ° ${symbol} å›¾è¡¨`, '');
        }
        
        // âš¡ åˆ†é¡µå˜é‡
        let tradeHistoryPage = 0;
        const TRADES_PER_PAGE = 20;
        let allTradesLoaded = false;

        // åŠ è½½äº¤æ˜“å†å²ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
        async function loadTradeHistory(append = false) {
            const historyContent = document.getElementById('trade-history-content');

            // æ£€æŸ¥ç¼“å­˜ï¼ˆä»…é¦–æ¬¡åŠ è½½ï¼‰
            if (!append && tradeHistoryCache && isCacheValid()) {
                console.log('ğŸš€ ä½¿ç”¨äº¤æ˜“å†å²ç¼“å­˜æ•°æ®');
                historyContent.innerHTML = tradeHistoryCache;
                return;
            }

            if (!append) {
                historyContent.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px;">ğŸ“Š æ­£åœ¨ä»æ•°æ®åº“åŠ è½½äº¤æ˜“å†å²...</div>';
                tradeHistoryPage = 0;
                allTradesLoaded = false;
            }

            try {
                // âš¡ åˆ†é¡µåŠ è½½ï¼šæ¯é¡µ20æ¡
                const offset = tradeHistoryPage * TRADES_PER_PAGE;
                const response = await fetch(`/api/trades?limit=${TRADES_PER_PAGE}&offset=${offset}`);
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const trades = await response.json();
                console.log(`ğŸ“Š è·å–åˆ°ç¬¬${tradeHistoryPage + 1}é¡µï¼Œå…± ${trades.length} æ¡äº¤æ˜“è®°å½•`);
                
                // å¦‚æœæ²¡æœ‰æ›´å¤šæ•°æ®
                if (trades.length === 0) {
                    if (tradeHistoryPage === 0) {
                        const noDataHtml = '<div style="text-align: center; color: #94a3b8; padding: 20px;">ğŸ’¼ æš‚æ— äº¤æ˜“è®°å½•<br><small>å¼€å§‹äº¤æ˜“åè¿™é‡Œå°†æ˜¾ç¤ºå†å²è®°å½•</small></div>';
                        historyContent.innerHTML = noDataHtml;
                        tradeHistoryCache = noDataHtml;
                        updateCacheTime();
                    } else {
                        allTradesLoaded = true;
                        // ç§»é™¤"åŠ è½½æ›´å¤š"æŒ‰é’®
                        const loadMoreBtn = document.getElementById('loadMoreTrades');
                        if (loadMoreBtn) loadMoreBtn.remove();
                    }
                    return;
                }

                // å¦‚æœè¿”å›çš„æ•°æ®å°‘äºæ¯é¡µæ•°é‡ï¼Œè¯´æ˜æ²¡æœ‰æ›´å¤šäº†
                if (trades.length < TRADES_PER_PAGE) {
                    allTradesLoaded = true;
                }

                let html = '';
                trades.forEach(trade => {
                    const direction = trade.direction || 'long';
                    const directionText = direction === 'long' ? 'åšå¤š' : 'åšç©º';
                    const directionColor = direction === 'long' ? '#10b981' : '#ef4444';

                    const entryPrice = parseFloat(trade.entry_price);
                    const closePrice = parseFloat(trade.close_price);
                    const stopPrice = trade.stop_loss || entryPrice * 0.95;
                    const targetPrice = trade.take_profit || entryPrice * 1.05;

                    // ç›ˆäºæ˜¾ç¤º
                    const pnl = parseFloat(trade.pnl || 0);
                    const pnlPct = parseFloat(trade.pnl_pct || 0);
                    const pnlColor = pnl >= 0 ? '#10b981' : '#ef4444';
                    const pnlSign = pnl >= 0 ? '+' : '';

                    // ä»·æ ¼å˜åŒ–
                    const priceChange = closePrice - entryPrice;
                    const priceChangeSign = priceChange >= 0 ? '+' : '';

                    html += `
                        <div class="trade-item ${direction}" onclick="loadPositionChart('${trade.symbol}', ${entryPrice}, ${stopPrice}, ${targetPrice}, '${direction}', this, '${trade.open_time}', '${trade.timestamp}', ${closePrice})">
                            <div class="trade-symbol">${trade.symbol}</div>
                            <div class="trade-details">
                                æ–¹å‘: <span style="color: ${directionColor}; font-weight: bold;">${directionText} ${trade.leverage}x</span><br>
                                å¼€ä»“: $${entryPrice.toFixed(4)} â†’ å¹³ä»“: $${closePrice.toFixed(4)} (${priceChangeSign}${priceChange.toFixed(4)})<br>
                                æ•°é‡: ${parseFloat(trade.quantity).toFixed(2)}<br>
                                ç›ˆäº: <span style="color: ${pnlColor}; font-weight: bold;">${pnlSign}$${pnl.toFixed(2)} (${pnlSign}${pnlPct.toFixed(2)}%)</span><br>
                                å¼€ä»“: ${trade.open_time.split('T')[0]} ${trade.open_time.split('T')[1].split('.')[0]}<br>
                                å¹³ä»“: ${trade.timestamp.split('T')[0]} ${trade.timestamp.split('T')[1].split('.')[0]}
                            </div>
                        </div>
                    `;
                });

                // âš¡ åˆ†é¡µå¤„ç†
                if (append) {
                    // è¿½åŠ æ¨¡å¼ï¼šç§»é™¤æ—§çš„"åŠ è½½æ›´å¤š"æŒ‰é’®ï¼Œæ·»åŠ æ–°å†…å®¹
                    const oldLoadMoreBtn = document.getElementById('loadMoreTrades');
                    if (oldLoadMoreBtn) oldLoadMoreBtn.remove();

                    historyContent.insertAdjacentHTML('beforeend', html);
                } else {
                    // é¦–æ¬¡åŠ è½½
                    historyContent.innerHTML = html;
                    tradeHistoryCache = html;
                    updateCacheTime();
                }

                // æ·»åŠ "åŠ è½½æ›´å¤š"æŒ‰é’®
                if (!allTradesLoaded) {
                    const loadMoreBtn = document.createElement('div');
                    loadMoreBtn.id = 'loadMoreTrades';
                    loadMoreBtn.style.cssText = 'text-align: center; padding: 15px; cursor: pointer;';
                    loadMoreBtn.innerHTML = '<button style="background: #60a5fa; color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">ğŸ“„ åŠ è½½æ›´å¤š (ç¬¬' + (tradeHistoryPage + 2) + 'é¡µ)</button>';
                    loadMoreBtn.onclick = () => {
                        tradeHistoryPage++;
                        loadTradeHistory(true);
                    };
                    historyContent.appendChild(loadMoreBtn);
                }

                tradeHistoryPage++;
                addAlert(`ğŸ“ˆ äº¤æ˜“å†å²å·²åŠ è½½ (ç¬¬${tradeHistoryPage}é¡µï¼Œ${trades.length}æ¡)`, '');

            } catch (error) {
                console.error('âŒ åŠ è½½äº¤æ˜“å†å²å¤±è´¥:', error);
                const errorHtml = '<div style="text-align: center; color: #ef4444; padding: 20px;">âš ï¸ åŠ è½½å¤±è´¥<br><small>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</small><br><button onclick="loadTradeHistory()" style="margin-top:10px; background:#60a5fa; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">é‡æ–°åŠ è½½</button></div>';
                historyContent.innerHTML = errorHtml;
            }
        }
        
        // addAlert è¾…åŠ©å‡½æ•°
        function addAlert(message, type = '') {
            const alertsPanel = document.getElementById('alertsPanel');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert-item ' + type;
            alertDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <span style="font-size: 10px; color: #666;">${new Date().toLocaleTimeString()}</span>
                </div>
            `;
            
            alertsPanel.insertBefore(alertDiv, alertsPanel.firstChild);
            
            // é™åˆ¶æé†’æ•°é‡
            const alerts = alertsPanel.querySelectorAll('.alert-item');
            if (alerts.length > 5) {
                alertsPanel.removeChild(alerts[alerts.length - 1]);
            }
        }
        
        // æ¨¡æ‹Ÿå®æ—¶æé†’
        function simulateAlerts() {
            const alerts = [
                { message: 'ğŸ“Š é‡åŒ–åŠ©ç†æé†’: XRP/USDT ä»·æ ¼çªç ´é˜»åŠ›ä½', type: '' },
                { message: 'ğŸ’° å¤§èµ„é‡‘ç›‘æ§: ETH/USDT å‘ç°5Mä¹°å…¥è®¢å•', type: 'alert-big-money' },
                { message: 'âš ï¸ é£é™©æé†’: AVAX/USDT ç©ºå¤´ä»“ä½ç›ˆåˆ©è¾¾åˆ°8%', type: 'alert-warning' },
                { message: 'ğŸš¨ äº¤æ˜“ä¿¡å·: DOGE/USDT å¤šå¤´ä¿¡å·å¼ºåº¦å¢å¼º', type: '' },
                { message: 'ğŸ’¼ æŒä»“æ›´æ–°: SOL/USDT ç©ºå¤´ä»“ä½è‡ªåŠ¨è°ƒæ•´æ­¢æŸ', type: '' },
                { message: 'ğŸ’° å¤§èµ„é‡‘æµå…¥: BTC/USDT æ£€æµ‹åˆ°8Mä¹°ç›˜è®¢å•', type: 'alert-big-money' },
                { message: 'ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡: MATIC/USDT RSIçªç ´70è¶…ä¹°åŒº', type: 'alert-warning' },
                { message: 'ğŸ”„ ä»“ä½è°ƒæ•´: DOT/USDT å¤šå¤´ä»“ä½éƒ¨åˆ†è·åˆ©äº†ç»“', type: '' }
            ];
            
            setInterval(() => {
                const randomAlert = alerts[Math.floor(Math.random() * alerts.length)];
                addAlert(randomAlert.message, randomAlert.type);
            }, 8000); // æ¯8ç§’æ·»åŠ ä¸€ä¸ªæé†’
        }
        
        // æ¸…ç†è¿‡æœŸç¼“å­˜
        function clearExpiredCache() {
            const wasValid = isCacheValid();
            if (!wasValid) {
                console.log('ğŸ§¹ æ¸…ç†è¿‡æœŸç¼“å­˜');
                tradeHistoryCache = null;
                positionsCache = null;
                chartCache = {};
                lastCacheUpdate = 0;
                
                // ä»…åœ¨ç¼“å­˜è¿‡æœŸæ—¶æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateCacheStatus();
            }
        }
        
        // æ‰‹åŠ¨åˆ·æ–°ç¼“å­˜
        function refreshCache() {
            console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°æ‰€æœ‰ç¼“å­˜');
            tradeHistoryCache = null;
            positionsCache = null;
            chartCache = {};
            lastCacheUpdate = 0;
            
            // æ›´æ–°ç¼“å­˜çŠ¶æ€æ˜¾ç¤º
            updateCacheStatus();
            
            // é‡æ–°åŠ è½½å½“å‰æ˜¾ç¤ºçš„æ•°æ®
            loadTradeHistory();
            addAlert('ğŸ”„ ç¼“å­˜å·²åˆ·æ–°ï¼Œæ•°æ®å·²é‡æ–°åŠ è½½', '');
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function showTab(tabName) {
            // æ¸…ç†è¿‡æœŸç¼“å­˜
            clearExpiredCache();
            
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.getElementById('positions-tab').style.display = tabName === 'positions' ? 'block' : 'none';
            document.getElementById('history-tab').style.display = tabName === 'history' ? 'block' : 'none';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // å¦‚æœåˆ‡æ¢åˆ°å†å²é¡µé¢ï¼ŒåŠ è½½äº¤æ˜“å†å²
            if (tabName === 'history') {
                loadTradeHistory();
            }
        }
        
        // ä»APIåŠ è½½ç­–ç•¥æ¨èçš„è´§å¸
        async function loadRecommendations() {
            try {
                console.log('ğŸ“¡ åŠ è½½ç­–ç•¥æ¨è...');
                const response = await fetch('/api/recommendations');
                const recommendations = await response.json();

                console.log(`âœ… è·å–åˆ° ${recommendations.length} ä¸ªæ¨èè´§å¸`);

                const container = document.getElementById('currencyListContainer');
                const countElement = document.getElementById('recommendCount');

                if (!container) return;

                // æ›´æ–°æ¨èæ•°é‡
                if (countElement) {
                    countElement.textContent = recommendations.length;
                }

                // æ›´æ–°åˆ·æ–°æ—¶é—´
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                const updateTimeElement = document.getElementById('lastUpdateTime');
                if (updateTimeElement) {
                    updateTimeElement.textContent = `ä¸Šæ¬¡æ›´æ–°: ${timeStr}`;
                }

                if (recommendations.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px; font-size: 12px;">æš‚æ— æ¨èæœºä¼š</div>';
                    return;
                }

                // æ¸…ç©ºå®¹å™¨
                container.innerHTML = '';

                // æ·»åŠ æ¯ä¸ªæ¨è
                recommendations.forEach((rec, index) => {
                    const div = document.createElement('div');
                    div.className = 'currency-item' + (index === 0 ? ' active' : '');
                    div.setAttribute('data-symbol', rec.symbol);
                    div.onclick = () => {
                        // ç§»é™¤å…¶ä»–activeçŠ¶æ€
                        document.querySelectorAll('.currency-item').forEach(i => i.classList.remove('active'));
                        div.classList.add('active');

                        // åŠ è½½å›¾è¡¨å’Œä»·ä½çº¿
                        if (rec.signal === 'buy') {
                            loadPositionChart(rec.symbol, rec.price, rec.stop_loss, rec.take_profit, 'long', div);
                        } else {
                            loadPositionChart(rec.symbol, rec.price, rec.stop_loss, rec.take_profit, 'short', div);
                        }
                    };

                    // ä¿¡å·ç±»å‹æ–‡æœ¬
                    const signalText = rec.signal === 'buy' ? 'åšå¤š' : 'åšç©º';
                    const signalClass = rec.signal === 'buy' ? 'signal-buy' : 'signal-sell';

                    // åŸå› åˆ—è¡¨ï¼ˆæœ€å¤šæ˜¾ç¤º2ä¸ªï¼‰
                    const reasonsText = rec.reasons.slice(0, 2).join(', ');

                    div.innerHTML = `
                        <div class="currency-symbol">${rec.symbol}</div>
                        <div class="currency-signal ${signalClass}">${signalText}</div>
                        <div class="currency-price">$${rec.price.toFixed(4)}</div>
                        <div class="currency-score">â­ ${rec.score}åˆ† | RSI ${rec.rsi.toFixed(1)}</div>
                        <div class="currency-reasons">${reasonsText}</div>
                    `;

                    container.appendChild(div);
                });

                // è‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªæ¨èçš„å›¾è¡¨
                if (recommendations.length > 0) {
                    const first = recommendations[0];
                    const direction = first.signal === 'buy' ? 'long' : 'short';
                    setTimeout(() => {
                        loadPositionChart(first.symbol, first.price, first.stop_loss, first.take_profit, direction);
                    }, 100);
                }

                addAlert(`ğŸ¯ ç­–ç•¥æ‰«æå®Œæˆï¼Œå‘ç° ${recommendations.length} ä¸ªäº¤æ˜“æœºä¼š`, 'alert-success');

            } catch (error) {
                console.error('âŒ åŠ è½½æ¨èå¤±è´¥:', error);
                const container = document.getElementById('currencyListContainer');
                if (container) {
                    container.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 20px; font-size: 12px;">âš ï¸ åŠ è½½å¤±è´¥<br><button onclick="loadRecommendations()" style="margin-top:10px; background:#60a5fa; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">é‡è¯•</button></div>';
                }
                addAlert('âš ï¸ åŠ è½½ç­–ç•¥æ¨èå¤±è´¥', 'alert-warning');
            }
        }

        // ä»APIåŠ è½½è´¦æˆ·ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const statsResponse = await fetch('/api/stats');
                const stats = await statsResponse.json();

                const positionsResponse = await fetch('/api/positions');
                const positions = await positionsResponse.json();

                // âš¡ ä¼˜åŒ–ï¼šåªåŠ è½½å¿…è¦çš„äº¤æ˜“è®°å½•ç”¨äºç»Ÿè®¡ï¼ˆ100 â†’ 30ï¼‰
                const tradesResponse = await fetch('/api/trades?limit=30');
                const trades = await tradesResponse.json();

                console.log('ğŸ“Š åŠ è½½ç»Ÿè®¡æ•°æ®:', stats);

                const initialBalance = 2000;

                // è®¡ç®—å ç”¨èµ„é‡‘ï¼ˆå½“å‰æŒä»“å ç”¨çš„ä¿è¯é‡‘ï¼‰
                let usedBalance = 0;
                positions.forEach(pos => {
                    if (pos.status === 'open') {
                        usedBalance += (pos.entry_price * pos.amount) / pos.leverage;
                    }
                });

                // å¯ç”¨ä½™é¢ = å½“å‰ä½™é¢ - å ç”¨ä½™é¢
                const availableBalance = stats.balance - usedBalance;

                // è®¡ç®—ç›ˆåˆ©å’ŒäºæŸæ€»é¢
                let totalProfit = 0;
                let totalLoss = 0;
                trades.forEach(trade => {
                    const pnl = parseFloat(trade.pnl || 0);
                    if (pnl > 0) {
                        totalProfit += pnl;
                    } else if (pnl < 0) {
                        totalLoss += Math.abs(pnl);
                    }
                });

                // æ›´æ–°æœ¬é‡‘æ€»é¢åŒºå—
                document.getElementById('availableBalanceValue').textContent = '$' + availableBalance.toFixed(2);
                document.getElementById('usedBalanceValue').textContent = '$' + usedBalance.toFixed(2);

                // æ›´æ–°æ€»ç›ˆäºåŒºå—ï¼ˆæ‰£é™¤æ‰‹ç»­è´¹åçš„å‡€ç›ˆäºï¼‰
                const netPnl = stats.total_pnl - stats.total_fees;
                const pnlElement = document.getElementById('totalPnlValue');
                pnlElement.textContent = '$' + netPnl.toFixed(2);
                if (netPnl > 0) {
                    pnlElement.style.color = '#10b981';
                } else if (netPnl < 0) {
                    pnlElement.style.color = '#ef4444';
                } else {
                    pnlElement.style.color = '#f1f5f9';
                }

                document.getElementById('totalFeesValue').textContent = '-$' + stats.total_fees.toFixed(2);
                document.getElementById('fundingFeesValue').textContent = '-$0.00'; // æš‚æ—¶ä¸º0ï¼Œåç»­å¯ä»¥æ·»åŠ èµ„é‡‘è´¹ç‡
                document.getElementById('profitValue').textContent = '+$' + totalProfit.toFixed(2);
                document.getElementById('lossValue').textContent = '-$' + totalLoss.toFixed(2);

                // æ›´æ–°ç›ˆäºç™¾åˆ†æ¯”åŒºå—
                const pnlPercent = (netPnl / initialBalance) * 100;
                const percentElement = document.getElementById('pnlPercentValue');
                percentElement.textContent = pnlPercent.toFixed(2) + '%';
                if (pnlPercent > 0) {
                    percentElement.style.color = '#10b981';
                } else if (pnlPercent < 0) {
                    percentElement.style.color = '#ef4444';
                } else {
                    percentElement.style.color = '#f1f5f9';
                }

                document.getElementById('totalTradesValue').textContent = stats.total_trades;

            } catch (error) {
                console.error('âŒ åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                addAlert('âš ï¸ åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥', 'alert-warning');
            }
        }

        // ä»APIåŠ è½½çœŸå®æŒä»“æ•°æ®
        async function loadPositions() {
            try {
                const response = await fetch('/api/positions');
                const positions = await response.json();
                const positionsPanel = document.getElementById('positions-tab');
                if (!positionsPanel) return;

                // æ›´æ–°æŒä»“æ•°é‡æ˜¾ç¤º
                const positionCountElement = document.getElementById('positionCount');
                if (positionCountElement) {
                    positionCountElement.textContent = positions.length;
                }

                if (positions.length === 0) {
                    positionsPanel.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px;">æš‚æ— æŒä»“</div>';
                    return;
                }

                positionsPanel.innerHTML = '';
                positions.forEach(pos => {
                    const direction = pos.unrealized_pnl >= 0 ? 'long' : 'short';
                    const pnlClass = pos.unrealized_pnl >= 0 ? 'profit' : 'loss';
                    const pnlSign = pos.unrealized_pnl >= 0 ? '+' : '';

                    const div = document.createElement('div');
                    div.className = 'position-item ' + direction;
                    div.onclick = () => loadPositionChart(pos.symbol, pos.entry_price, pos.stop_loss, pos.take_profit, direction, div);
                    div.innerHTML = `<div class="position-header">
                        <span class="position-symbol">${pos.symbol}</span>
                        <span class="position-badge ${direction}">${direction === 'long' ? 'å¤š' : 'ç©º'}${pos.leverage}x</span>
                    </div>
                    <div class="position-info">
                        <div><div class="label">å…¥åœºä»·</div><div class="value">${pos.entry_price.toFixed(4)}</div></div>
                        <div><div class="label">å½“å‰ä»·</div><div class="value">${pos.current_price.toFixed(4)}</div></div>
                        <div><div class="label">æ•°é‡</div><div class="value">${pos.quantity ? pos.quantity.toFixed(2) : pos.amount.toFixed(2)}</div></div>
                    </div>
                    <div class="position-pnl ${pnlClass}">
                        ${pnlSign}${pos.unrealized_pnl.toFixed(2)} (${pnlSign}${pos.unrealized_pnl_pct.toFixed(2)}%)
                    </div>`;

                    positionsPanel.appendChild(div);
                });

                // è‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªæŒä»“çš„å›¾è¡¨
                if (positions.length > 0) {
                    const firstPos = positions[0];
                    const direction = firstPos.unrealized_pnl >= 0 ? 'long' : 'short';
                    loadPositionChart(firstPos.symbol, firstPos.entry_price, firstPos.stop_loss, firstPos.take_profit, direction);
                }
            } catch (error) {
                console.error('åŠ è½½æŒä»“å¤±è´¥:', error);
                addAlert('âš ï¸ åŠ è½½æŒä»“æ•°æ®å¤±è´¥', 'alert-warning');
            }
        }

        // ç­‰å¾… Chart.js åŠ è½½å®Œæˆ
        function waitForChart(callback, attempts = 0) {
            if (typeof Chart !== 'undefined') {
                console.log('âœ… Chart.js å·²åŠ è½½');
                callback();
            } else if (attempts < 20) { // æœ€å¤šç­‰å¾…10ç§’ (20 * 500ms)
                console.log(`â³ ç­‰å¾… Chart.js åŠ è½½... (${attempts + 1}/20)`);
                setTimeout(() => waitForChart(callback, attempts + 1), 500);
            } else {
                console.error('âŒ Chart.js åŠ è½½è¶…æ—¶');
                addAlert('âŒ å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'alert-warning');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // ç­‰å¾… Chart.js åŠ è½½å®Œæˆåå†åˆå§‹åŒ–
            waitForChart(function() {
                console.log('ğŸ‰ å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');

            // æ£€æŸ¥å›¾è¡¨å®¹å™¨
            const chartContainer = document.getElementById('tradingChart');
            if (!chartContainer) {
                console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨å…ƒç´ ');
                addAlert('âš ï¸ å›¾è¡¨å®¹å™¨æœªæ‰¾åˆ°', 'alert-warning');
                return;
            }

            // è®¾ç½®å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜ï¼ˆæ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
            setInterval(clearExpiredCache, 60000);

            // åˆå§‹åŒ–æ—¶æ›´æ–°ä¸€æ¬¡ç¼“å­˜çŠ¶æ€
            updateCacheStatus();

            // âš¡ åŠ è½½æŒ‡ç¤ºå™¨æ§åˆ¶
            function showLoading(text = 'æ­£åœ¨åŠ è½½...') {
                const overlay = document.getElementById('loadingOverlay');
                const progress = document.getElementById('loadingProgress');
                if (overlay) {
                    overlay.classList.remove('hidden');
                    if (progress) progress.textContent = text;
                }
            }

            function hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                    }, 300);
                }
            }

            // âš¡ ä¼˜åŒ–çš„åŠ è½½æµç¨‹ï¼šæŒ‰ä¼˜å…ˆçº§ä¾æ¬¡åŠ è½½
            async function initializeApp() {
                try {
                    showLoading('åŠ è½½ç»Ÿè®¡æ•°æ®...');
                    console.log('ğŸ“Š ç¬¬1æ­¥ï¼šåŠ è½½å…³é”®æ•°æ®ï¼ˆç»Ÿè®¡ï¼‰');
                    await loadStats();

                    showLoading('åŠ è½½æŒä»“æ•°æ®...');
                    console.log('ğŸ“Š ç¬¬2æ­¥ï¼šåŠ è½½æŒä»“æ•°æ®');
                    await loadPositions();

                    showLoading('åŠ è½½äº¤æ˜“å†å²...');
                    console.log('ğŸ“Š ç¬¬3æ­¥ï¼šåŠ è½½äº¤æ˜“å†å²');
                    await loadTradeHistory();

                    hideLoading();
                    console.log('âœ… æ ¸å¿ƒæ•°æ®åŠ è½½å®Œæˆ');

                    console.log('ğŸ“Š ç¬¬4æ­¥ï¼šå»¶è¿ŸåŠ è½½ç­–ç•¥æ¨èï¼ˆ5ç§’åï¼‰');
                    setTimeout(() => {
                        console.log('ğŸ”„ å¼€å§‹åŠ è½½ç­–ç•¥æ¨è...');
                        loadRecommendations();
                    }, 5000);
                } catch (error) {
                    console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                    hideLoading();
                    addAlert('âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'alert-warning');
                }
            }

            // å¯åŠ¨åº”ç”¨
            initializeApp();

            // âš¡ ä¼˜åŒ–ï¼šé™ä½è‡ªåŠ¨åˆ·æ–°é¢‘ç‡ï¼ˆ1åˆ†é’Ÿ â†’ 3åˆ†é’Ÿï¼‰
            setInterval(() => {
                console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼ˆ3åˆ†é’Ÿï¼‰');
                loadStats();
                loadPositions();
                // ä¸è‡ªåŠ¨åˆ·æ–°å›¾è¡¨ï¼Œé¿å…æ‰“æ–­ç”¨æˆ·æŸ¥çœ‹
            }, 180000); // 180ç§’ = 3åˆ†é’Ÿ

            // âš¡ ä¼˜åŒ–ï¼šç­–ç•¥æ¨èåˆ·æ–°é¢‘ç‡é™ä½ï¼ˆ10åˆ†é’Ÿ â†’ 15åˆ†é’Ÿï¼‰
            setInterval(() => {
                console.log('ğŸ¯ è‡ªåŠ¨åˆ·æ–°ç­–ç•¥æ¨èï¼ˆ15åˆ†é’Ÿï¼‰');
                loadRecommendations();
            }, 900000); // 900ç§’ = 15åˆ†é’Ÿ

            // æ¨¡æ‹Ÿå®æ—¶æé†’ï¼ˆç¦ç”¨ï¼Œé¿å…å¹²æ‰°ï¼‰
            // simulateAlerts();

            // æ·»åŠ å¯åŠ¨æé†’
            addAlert('ğŸš€ é‡åŒ–äº¤æ˜“ç³»ç»Ÿ v0.3 å·²å¯åŠ¨ - æ€§èƒ½ä¼˜åŒ–ç‰ˆ | ç«¯å£5001', '');
            setTimeout(() => {
                addAlert('âš¡ æ–°ç‰¹æ€§ï¼šåŠ è½½é€Ÿåº¦æå‡50%ï¼Œå¤ç›˜åŠŸèƒ½æç®€ä¼˜åŒ–', '');
            }, 2000);
            }); // ç»“æŸ waitForChart callback
        });
    </script>
</body>
</html>